
```{r results = 'hide'}
library(rhdf5)
library(SpatialExperiment)
library(ggplot2)
library(patchwork) # combine multiple plots
source("code/stomicsFunctions.R")
```

# Loading data into R

One of the first hurdles to analyse STOmics data in R getting it into a suitable 
format. The outputs are all [anndata](https://anndata.readthedocs.io/en/stable/)
files, and we ideally would like either a Seurat object or SpatialExperiment
object.

## Format hell

SPE, SCE, SFE, Seurat, Anndata

## Options for conversion

Unfortunately, there are many options, none of them quite perfect. Here are the
ones that I know of:

- Use the StereoPy R script to create a Seurat object [format conversion](https://stereopy.readthedocs.io/en/latest/Tutorials/Format_Conversion.html)
  - This method is pretty reliable, but it's a command line script rather than
    a library, and only gives you Seurat objects
- Use a `reticulate` based package (calls into Python from R)
  - For example, [`anndata` from CRAN](https://cran.r-project.org/web/packages/anndata/readme/README.html)
  - This gets you the data, but you still have to convert it somehow
- Use [`schard`](https://github.com/cellgeni/schard)
  - This is a nice little library I've only recently discovered
  - It will get you most of the way, but can't quite deal with Stereo-seq h5ad quirks yet
- Use some custom `rhdf5` code 
  - This is what I've done for this tutorial. It's probably good to understand how the formats differ.

For this workshop, I've put all the loading code into an external script, `stomicsFunctions.R`.
You don't need to worry too much about the details, and this should work with the current versions
of SAW. 

## Inspecting our files

It's useful to be able to inspect h5ad files to verify their structure.
Let's take a look at the SAW outputs:


### gef 

The gef files contain the original expression matrix. This is difficult to process
in R. This is just an HDF5 file, so you can inspect it with `h5ls`

```{r}

# Note, this is only in the optional downloads. Don't worry if you didn't download it.
input_file <- "stomics/raw/visualization/C04042E3.tissue.gef"

# We can look inside the gef. However, it's not in a format we can directly use.
counts <- h5read(input_file, "/geneExp/bin50/gene")

# We can just sort through the features (noting the prevalence of mitochondrial genes).
counts[order(counts$count, decreasing=T),]
```

### h5ad

The h5ad files are AnnData format, and contain a count matrix in a usable format.
They also contain other analysis outputs created by SAW.

## SpatialExperiment

```{r}
# We can free up memory by removing those counts
rm(counts)

# Let's load an h5ad instead
h5ad_file <- "stomics/raw/visualization/C04042E3.bin50_1.0.h5ad"

# Read in the matrix data (CSR format)
matrix_data <- h5adMatrixLoad(h5ad_file, "/raw/X")

# Check shape of matrix
dim(matrix_data)
```


```{r}
# Read in row and col data (as per anndata format)
rowdata <- anndataDataframe(h5ad_file, "var")
rowdata
```
```{r}
coldata <- anndataDataframe(h5ad_file, "obs")
coldata
```

We can see that the umap and PCA embeddings are stored here too:

```{r}
# Let's explore the umap and pca, and recreate it
umap <- h5adMatrixLoad(h5ad_file, "/obsm/X_umap", sparse=F)
umap <- data.frame(umap1 = umap[1,], umap2 = umap[2,], row.names = rownames(coldata))

```

```{r}
# Read in spatial information, convert to the way SpatialExperiment prefers
spatial_coords <- h5read(h5ad_file, "/obsm/spatial")
spatial_coords <- data.matrix(data.frame(
  x=spatial_coords[1,],
  y=spatial_coords[2,],
  row.names = rownames(coldata)
))
```



```{r}
spe <- SpatialExperiment(
  assays = list(counts = matrix_data),
  reducedDims = list(umap = umap),
  colData = coldata, # spatial bins
  rowData = rowdata, # features
  spatialCoords = spatial_coords
)
```


Some basic QC:

```{r}
spe

```


```{r}
ggplot(spatialCoords(spe), aes(x, y, color = colData(spe)$total_counts)) +
  geom_point(size = 0.1) +
  theme(aspect.ratio=1) +
  scale_color_viridis_c() +
  labs(
    title = "Raw data",
    color = "total counts"
  )
```

Let's try plotting the UMAP. It'll hopefully look like the one we see in the report.

```{r}
# Let's plot the UMAP
spatial_plot <- ggplot(spatialCoords(spe), aes(x, y, color = colData(spe)$leiden)) +
  geom_point(size = 0.1) +
  theme(aspect.ratio=1) +
  scale_color_discrete(guide = "none") +
  ggtitle("Spatial plot")

umap_plot <- ggplot(reducedDims(spe)$umap, aes(umap1, umap2, color = colData(spe)$leiden)) +
  geom_point(size = 0.1) +
  theme(aspect.ratio=1) +
  scale_color_discrete() +
  labs(
    title = "UMAP",
    color = "Leiden clusters"
  )

spatial_plot + umap_plot
```

## Loading geoJSON 

TODO: prebake some geojson files

```{r}
library(sf)
geojson <- "stomics/raw/C04042E3_20241117151457.lasso.geojson"
sf_object <- read_sf(geojson, crs = NA)
polygons <- st_collection_extract(sf_object)
polygons$sample_id <- "sample01"

# Can just plot these normally too
# plot(sf_object$geometry, col = "grey")

ggplot(polygons) +
  geom_sf(fill = "#69b3a2", color = "white") +
  coord_sf(datum=NA) +
  theme_void()
```


```{r}

# The polygons I get from StereoMap aren't closed
# This causes issues with some functions that expect this
# So this just modifies a simple feature collection with a polygon to close it
closePolygon <- function(poly) {
  # Extract coordinates
  xy <- st_coordinates(poly)[,1:2]
  # Append first xy pair to end (closing the polygon)
  xy_fix <- rbind(xy, xy[1,])
  new_poly <- st_polygon(list(xy_fix))
  geom <- st_sfc(new_poly)
  sf <- st_sf(
    sample_id=poly$sample_id,
    geometry <- geom
  )
  return(sf)
}

region_1 <- closePolygon(polygons[1,])
region_2 <- closePolygon(polygons[2,])


# Make a test region

st <- 10000
si <- 5000
en <- st + si
geom <- st_polygon(list(matrix(
  c(st, st,  # Bottom-left
    en, st,  # Bottom-right
    en, en,  # Top-right
    st, en,  # Top-left
    st, st), # Back to Bottom-left to close
  ncol = 2, byrow = TRUE
)))

polygon_data <- data.frame(
  sample_id = "sample01",                 # ID column
  name = "Test Polygon"   # Example attribute
)

# Combine the data frame with the geometry to create an sf object
polygon_sf <- st_sf(polygon_data, geometry = st_sfc(geom))

```

Next, let's upgrade to a SpatialFeatureExperiment, which allows us to use these geometries.

```{r}
library(SpatialFeatureExperiment)
sfe <- toSpatialFeatureExperiment(spe, 
                                    annotGeometries = list(
                                      region_1 = region_1
                                    ),
                                    spotDiameter = 0.5 # Somewhat innacurate to do this..
                                  )

crop(sfe, polygon_sf)
```

```{r}
ggplot() +
  geom_point(data = spatialCoords(spe), aes(x, y, color = colData(spe)$leiden)) +
  geom_sf(data = annotGeometry(sfe, "region_1"), fill = NA) +
  #geom_sf(data = annotGeometry(sfe, "region_2"), fill = NA) +
  coord_sf(datum=NA) +
  scale_color_discrete() +
  theme(aspect.ratio=1)
```



```{r}
cropped <- crop(sfe, polygon_sf)
cropped

ggplot() +
  geom_point(data = spatialCoords(cropped), aes(x, y, color = colData(cropped)$leiden)) +
  scale_color_discrete() +
  theme(aspect.ratio=1)
```
```{r}
# Why won't my outlines work

```


## Differential expression



(you can also use SAW)

- https://lmweber.org/PrinciplesSTA/devel/pages/seq-differential-expression.html
